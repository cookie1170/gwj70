[gd_scene load_steps=46 format=3 uid="uid://tkgv3h3sywn1"]

[ext_resource type="Script" path="res://scripts/controller.gd" id="1_g2unk"]
[ext_resource type="Texture2D" uid="uid://cutk8x3kifwpm" path="res://assets/sprites/heart.png" id="3_5lxlu"]
[ext_resource type="Texture2D" uid="uid://c0rsjbs46iwa8" path="res://assets/sprites/player_bow.png" id="5_72noo"]
[ext_resource type="Texture2D" uid="uid://b5bv744gw03tq" path="res://assets/sprites/player_run.png" id="6_17qkr"]
[ext_resource type="Texture2D" uid="uid://bio133ivsqo0y" path="res://assets/sprites/player_sword.png" id="7_yrjhb"]
[ext_resource type="Texture2D" uid="uid://3rlvknkh2y45" path="res://assets/sprites/player_jump.png" id="8_3yff5"]
[ext_resource type="Texture2D" uid="uid://cg8i4g1se77yd" path="res://assets/sprites/jump_old.png" id="9_v7dw1"]
[ext_resource type="Texture2D" uid="uid://cjh5a1ff7vve7" path="res://assets/sprites/attack_old.png" id="9_vtlkq"]
[ext_resource type="Texture2D" uid="uid://qo1som5tjurh" path="res://assets/sprites/player_idle.png" id="10_y0pdy"]
[ext_resource type="Texture2D" uid="uid://ctrmlynlhvhuc" path="res://assets/sprites/idle_old.png" id="11_b68pt"]
[ext_resource type="Texture2D" uid="uid://cwxyx8x3qvvuc" path="res://assets/sprites/run_old.png" id="12_n84bn"]

[sub_resource type="GDScript" id="GDScript_or6la"]
script/source = "#	Copyright (c) 2019 Lawnjelly
#
#	Permission is hereby granted, free of charge, to any person obtaining a copy
#	of this software and associated documentation files (the \"Software\"), to deal
#	in the Software without restriction, including without limitation the rights
#	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
#	copies of the Software, and to permit persons to whom the Software is
#	furnished to do so, subject to the following conditions:
#
#	The above copyright notice and this permission notice shall be included in all
#	copies or substantial portions of the Software.
#
#	THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
#	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
#	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
#	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
#	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
#	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
#	SOFTWARE.

extends Node2D


@export
var target: NodePath:
	get:
		return target
	set(v):
		target = v
		if is_inside_tree():
			_FindTarget()

var _m_Target: Node2D
var _m_Flip:bool = false

var _m_Trans_curr: Transform2D = Transform2D()
var _m_Trans_prev: Transform2D = Transform2D()

const SF_ENABLED = 1 << 0
const SF_GLOBAL_IN = 1 << 1
const SF_GLOBAL_OUT = 1 << 2
const SF_TOP_LEVEL = 1 << 3
const SF_INVISIBLE = 1 << 4

@export_flags(\"enabled\", \"global in\", \"global out\", \"top level\") var flags: int = SF_ENABLED | SF_GLOBAL_IN | SF_GLOBAL_OUT:
	set(v):
		flags = v
		# we may have enabled or disabled
		_SetProcessing()
	get:
		return flags

##########################################################################################
# USER FUNCS


# call this checked e.g. starting a level, AFTER moving the target
# so we can update both the previous and current values
func teleport():
	_RefreshTransform()
	_m_Trans_prev = _m_Trans_curr

	# call frame upate to make sure all components of the node are set
	_process(0)


func set_enabled(bEnable: bool):
	_ChangeFlags(SF_ENABLED, bEnable)
	_SetProcessing()


func is_enabled():
	return _TestFlags(SF_ENABLED)


##########################################################################################


func _ready():
	set_process_priority(100)
	Engine.set_physics_jitter_fix(0.0)
	set_as_top_level(_TestFlags(SF_TOP_LEVEL))


func _SetProcessing():
	var bEnable = _TestFlags(SF_ENABLED)
	if _TestFlags(SF_INVISIBLE):
		bEnable = false

	set_process(bEnable)
	set_physics_process(bEnable)
	set_as_top_level(_TestFlags(SF_TOP_LEVEL))


func _enter_tree():
	# might have been moved
	_FindTarget()


func _notification(what):
	match what:
		# invisible turns unchecked processing
		NOTIFICATION_VISIBILITY_CHANGED:
			_ChangeFlags(SF_INVISIBLE, is_visible_in_tree() == false)
			_SetProcessing()


func _RefreshTransform():

	if _HasTarget() == false:
		return

	_m_Trans_prev = _m_Trans_curr

	if _TestFlags(SF_GLOBAL_IN):
		_m_Trans_curr = _m_Target.get_global_transform()
	else:
		_m_Trans_curr = _m_Target.get_transform()

	_m_Flip = false
	# Ideally we would use determinant core function, as in commented line below, but we
	# need to workaround for backward compat.
	# if (_m_Trans_prev.determinant() < 0) != (_m_Trans_curr.determinant() < 0):
	
	if (_Determinant_Sign(_m_Trans_prev) != _Determinant_Sign(_m_Trans_curr)):
		_m_Flip = true

func _Determinant_Sign(t:Transform2D)->bool:
	# Workaround Transform2D determinant function not being available
	# until 3.6 / 4.1.
	# We calculate determinant manually, slower but compatible to lower
	# godot versions.
	var d = (t.x.x * t.y.y) - (t.x.y * t.y.x)
	return d >= 0.0
	

func _FindTarget():
	_m_Target = null

	# If no target has been assigned in the property,
	# default to using the parent as the target.
	if target.is_empty():
		var parent = get_parent()
		if parent and (parent is Node2D):
			_m_Target = parent
		return
		
	var targ = get_node(target)

	if ! targ:
		printerr(\"ERROR SmoothingNode2D : Target \" + str(target) + \" not found\")
		return

	if not targ is Node2D:
		printerr(\"ERROR SmoothingNode2D : Target \" + str(target) + \" is not Node2D\")
		target = \"\"
		return

	# if we got to here targ is correct type
	_m_Target = targ

func _HasTarget() -> bool:
	if _m_Target == null:
		return false

	# has not been deleted?
	if is_instance_valid(_m_Target):
		return true

	_m_Target = null
	return false


func _process(_delta):
	var f = Engine.get_physics_interpolation_fraction()

	var tr = Transform2D()
	tr.origin = lerp(_m_Trans_prev.origin, _m_Trans_curr.origin, f)
	tr.x = lerp(_m_Trans_prev.x, _m_Trans_curr.x, f)
	tr.y = lerp(_m_Trans_prev.y, _m_Trans_curr.y, f)

	# When a sprite flip is detected, turn off interpolation for that tick.
	if _m_Flip:
		tr = _m_Trans_curr

	if _TestFlags(SF_GLOBAL_OUT) and not _TestFlags(SF_TOP_LEVEL):
		set_global_transform(tr)
	else:
		set_transform(tr)


func _physics_process(_delta):
	_RefreshTransform()


func _SetFlags(f):
	flags |= f


func _ClearFlags(f):
	flags &= ~f


func _TestFlags(f):
	return (flags & f) == f


func _ChangeFlags(f, bSet):
	if bSet:
		_SetFlags(f)
	else:
		_ClearFlags(f)
"

[sub_resource type="AtlasTexture" id="AtlasTexture_uw3vj"]
atlas = ExtResource("3_5lxlu")
region = Rect2(0, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_4jgnb"]
atlas = ExtResource("3_5lxlu")
region = Rect2(0, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_0xifd"]
atlas = ExtResource("3_5lxlu")
region = Rect2(16, 0, 16, 16)

[sub_resource type="SpriteFrames" id="SpriteFrames_l0cha"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_uw3vj")
}],
"loop": true,
"name": &"heart_full",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_4jgnb")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_0xifd")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_4jgnb")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_0xifd")
}],
"loop": false,
"name": &"heart_hit",
"speed": 5.0
}]

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_v4dux"]
radius = 27.0
height = 64.0

[sub_resource type="AtlasTexture" id="AtlasTexture_ju1s0"]
atlas = ExtResource("5_72noo")
region = Rect2(0, 0, 32, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_tfsht"]
atlas = ExtResource("5_72noo")
region = Rect2(32, 0, 32, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_dh6ls"]
atlas = ExtResource("5_72noo")
region = Rect2(64, 0, 32, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_te7bf"]
atlas = ExtResource("9_vtlkq")
region = Rect2(0, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_210o3"]
atlas = ExtResource("9_vtlkq")
region = Rect2(16, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_r8qeu"]
atlas = ExtResource("9_vtlkq")
region = Rect2(32, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_3tl8k"]
atlas = ExtResource("9_vtlkq")
region = Rect2(48, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_fbk8l"]
atlas = ExtResource("7_yrjhb")
region = Rect2(0, 0, 32, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_eij0a"]
atlas = ExtResource("7_yrjhb")
region = Rect2(32, 0, 32, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_bpqdg"]
atlas = ExtResource("7_yrjhb")
region = Rect2(64, 0, 32, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_l3mk4"]
atlas = ExtResource("9_v7dw1")
region = Rect2(48, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_je621"]
atlas = ExtResource("10_y0pdy")
region = Rect2(0, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_0q15w"]
atlas = ExtResource("10_y0pdy")
region = Rect2(16, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_a2hbk"]
atlas = ExtResource("11_b68pt")
region = Rect2(0, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_hxnbl"]
atlas = ExtResource("11_b68pt")
region = Rect2(16, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_4fr5p"]
atlas = ExtResource("8_3yff5")
region = Rect2(0, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_6vlbg"]
atlas = ExtResource("9_v7dw1")
region = Rect2(0, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_528p4"]
atlas = ExtResource("9_v7dw1")
region = Rect2(16, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_umptx"]
atlas = ExtResource("9_v7dw1")
region = Rect2(32, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_y3hbw"]
atlas = ExtResource("6_17qkr")
region = Rect2(0, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_n2q25"]
atlas = ExtResource("6_17qkr")
region = Rect2(16, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_hnr5v"]
atlas = ExtResource("6_17qkr")
region = Rect2(32, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_ckwfc"]
atlas = ExtResource("6_17qkr")
region = Rect2(48, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_735xp"]
atlas = ExtResource("12_n84bn")
region = Rect2(0, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_cuiv8"]
atlas = ExtResource("12_n84bn")
region = Rect2(16, 0, 16, 16)

[sub_resource type="AtlasTexture" id="AtlasTexture_ejkvl"]
atlas = ExtResource("12_n84bn")
region = Rect2(32, 0, 16, 16)

[sub_resource type="SpriteFrames" id="SpriteFrames_1lka1"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_ju1s0")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_tfsht")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_dh6ls")
}],
"loop": false,
"name": &"attack_bow",
"speed": 7.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_te7bf")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_210o3")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_r8qeu")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_3tl8k")
}],
"loop": false,
"name": &"attack_old",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_fbk8l")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_eij0a")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_bpqdg")
}],
"loop": false,
"name": &"attack_sword",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": ExtResource("8_3yff5")
}],
"loop": true,
"name": &"fall",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_l3mk4")
}],
"loop": true,
"name": &"fall_old",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_je621")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_0q15w")
}],
"loop": true,
"name": &"idle",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_a2hbk")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_hxnbl")
}],
"loop": true,
"name": &"idle_old",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_4fr5p")
}],
"loop": true,
"name": &"jump",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_6vlbg")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_528p4")
}, {
"duration": 1000.0,
"texture": SubResource("AtlasTexture_umptx")
}],
"loop": true,
"name": &"jump_old",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_y3hbw")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_n2q25")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_hnr5v")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ckwfc")
}],
"loop": true,
"name": &"run",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_735xp")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_cuiv8")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ejkvl")
}],
"loop": true,
"name": &"run_old",
"speed": 5.0
}]

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_ufq3f"]
radius = 5.5
height = 11.0

[node name="player" type="CharacterBody2D" groups=["player"]]
collision_layer = 2
script = ExtResource("1_g2unk")

[node name="smoothing_hearts" type="Node2D" parent="."]
script = SubResource("GDScript_or6la")

[node name="heart_1" type="AnimatedSprite2D" parent="smoothing_hearts"]
position = Vector2(-32, -50)
scale = Vector2(2, 2)
sprite_frames = SubResource("SpriteFrames_l0cha")
animation = &"heart_full"

[node name="heart_2" type="AnimatedSprite2D" parent="smoothing_hearts"]
position = Vector2(0, -50)
scale = Vector2(2, 2)
sprite_frames = SubResource("SpriteFrames_l0cha")
animation = &"heart_full"

[node name="heart_3" type="AnimatedSprite2D" parent="smoothing_hearts"]
position = Vector2(32, -50)
scale = Vector2(2, 2)
sprite_frames = SubResource("SpriteFrames_l0cha")
animation = &"heart_full"
autoplay = "heart_full"

[node name="hitbox" type="CollisionShape2D" parent="."]
shape = SubResource("CapsuleShape2D_v4dux")

[node name="coyote_timer" type="Timer" parent="."]
wait_time = 0.2
one_shot = true

[node name="shoot_cd" type="Timer" parent="."]
wait_time = 0.5

[node name="i_frame_timer" type="Timer" parent="."]
wait_time = 0.2
one_shot = true

[node name="smoothing_sprite" type="Node2D" parent="."]
script = SubResource("GDScript_or6la")

[node name="sprite" type="AnimatedSprite2D" parent="smoothing_sprite"]
scale = Vector2(4, 4)
sprite_frames = SubResource("SpriteFrames_1lka1")
animation = &"idle"
autoplay = "idle"

[node name="atk_area" type="Area2D" parent="."]
position = Vector2(20, 0)
scale = Vector2(8, 8)
collision_mask = 4

[node name="atk_hitbox" type="CollisionShape2D" parent="atk_area"]
shape = SubResource("CapsuleShape2D_ufq3f")
debug_color = Color(0.7, 0.606667, 0, 0.419608)

[connection signal="timeout" from="coyote_timer" to="." method="on_coyote_timeout"]
[connection signal="timeout" from="i_frame_timer" to="." method="_on_i_frame_timeout"]
[connection signal="body_entered" from="atk_area" to="." method="_on_atk_entered"]
